<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WEIRDFORUMS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: VT323 for retro style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* Custom styles based on the concept art */
        body {
            font-family: 'VT323', monospace;
            background-color: #301f1f; /* Dark brown */
            color: #e6dccb; /* Cream/tan */
            /* Disable all rounding */
            --tw-border-radius: 0 !important;
        }
        
        /* Main title */
        h1 {
            color: #e6dccb;
        }

        /* Horizontal lines */
        hr {
            border-color: #e6dccb;
        }

        /* Inputs and Textareas */
        input[type="text"],
        textarea {
            background: transparent;
            border: none;
            border-bottom: 2px solid #e6dccb;
            color: #e6dccb;
            font-family: 'VT323', monospace;
            font-size: 1.25rem; /* 20px */
            border-radius: 0;
            padding: 8px 0;
        }
        input[type="text"]::placeholder,
        textarea::placeholder {
            color: #a19279; /* Darker tan for placeholder */
            opacity: 1;
        }
        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-bottom-color: #ffffff;
            box-shadow: none;
            --tw-ring-shadow: none !important;
        }

        /* Buttons */
        .btn,
        button {
            background-color: #4a542b; /* Dark olive/green */
            color: #e6dccb;
            padding: 8px 16px;
            font-family: 'VT323', monospace;
            font-size: 1.125rem; /* 18px */
            cursor: pointer;
            border: none;
            border-radius: 0;
            text-transform: uppercase;
            transition: background-color 0.2s;
        }
        .btn:hover,
        button:hover {
            background-color: #5c683d; /* Lighter olive */
        }
        .btn:disabled,
        button:disabled {
            background-color: #3e4425;
            color: #a19279;
            cursor: not-allowed;
        }

        /* Special button styles for reactions */
        .btn-like {
            background-color: #4a542b;
        }
        .btn-like.active {
            background-color: #22c55e; /* green-500 */
            color: #ffffff;
        }
        .btn-dislike {
            background-color: #4a542b;
        }
        .btn-dislike.active {
            background-color: #ef4444; /* red-500 */
            color: #ffffff;
        }
        
        /* Modal styles */
        #modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        #modalContent {
            background-color: #301f1f;
            border: 4px solid #e6dccb;
            border-radius: 0;
            box-shadow: none;
        }

        /* Remove all rounded corners from Tailwind classes */
        .rounded-lg, .rounded-md, .rounded-full, .rounded {
            border-radius: 0 !important;
        }

        /* Remove all shadows from Tailwind classes */
        .shadow-lg, .shadow-md, .shadow-2xl, .shadow {
            box-shadow: none !important;
        }
        
        /* Style for file input */
        .file-label {
            color: #a19279;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1.125rem; /* 18px */
        }
        .file-label:hover {
            color: #e6dccb;
        }
        
        /* Style for links */
        a, .link {
            color: #e6dccb;
            text-decoration: underline;
        }
        a:hover, .link:hover {
            color: #ffffff;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="container mx-auto max-w-4xl p-4">

        <!-- Header -->
        <header class="mb-4">
            <div class="flex justify-between items-center text-lg">
                <!-- Patch Notes Button -->
                <button id="updateLogButton" onclick="showUpdateLog()">Patch Notes</button>
                
                <!-- Title -->
                <h1 class="text-5xl font-bold text-center">WEIRDFORUMS</h1>
                
                <!-- Report a Bug Button -->
                <button id="reportBugButton" onclick="showReportBugModal()" class="flex items-center gap-2">
                    <!-- Simple SVG Bug Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="butt" stroke-linejoin="bevel">
                        <path d="M20 9V7a2 2 0 0 0-2-2h-2.5a1 1 0 0 1-1-1.5A2.5 2.5 0 0 0 12 2a2.5 2.5 0 0 0-2.5 1.5A1 1 0 0 1 8.5 5H6a2 2 0 0 0-2 2v2"/>
                        <path d="M12 11h.01"/>
                        <path d="m15 14-1 3"/>
                        <path d="m9 14 1 3"/>
                        <path d="M4 14h16"/>
                        <path d="M17 22h-1a3 3 0 0 1-3-3v-3h-2v3a3 3 0 0 1-3 3H7"/>
                        <path d="M4 18v-4"/>
                        <path d="M20 18v-4"/>
                    </svg>
                    Report a bug
                </button>
            </div>
            <hr class="my-4"/>
        </header>

        <!-- Thread Creation Form -->
        <div id="threadForm" class="my-10 text-center">
            <div class="space-y-6 max-w-lg mx-auto">
                <h2 class="text-3xl">Start a New Thread</h2>
                <input type="text" id="threadTitle" placeholder="Thread Title..." class="w-full text-center text-2xl">
                <textarea id="threadContent" placeholder="What's on your mind?..." rows="4" class="w-full text-lg"></textarea>
                <div class="flex items-center justify-center gap-8">
                    <!-- Simple File Input -->
                    <label for="imageFile" class="file-label">
                        Attach Image
                    </label>
                    <input type="file" id="imageFile" accept="image/*" class="hidden">
                    
                    <button id="threadSubmitButton" onclick="createThread()">
                        <span id="threadSubmitSpinner" class="hidden">...</span>
                        <span id="threadSubmitText">Start Thread</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Threads Header -->
        <div class="flex justify-between items-end mb-4">
             <h2 class="text-4xl">Threads</h2>
             <p id="userInfo" class="text-lg text-main/80">Initializing...</p>
        </div>
        <hr class="my-4"/>

        <!-- Threads Container -->
        <div id="threadsContainer" class="space-y-1">
            <!-- Threads will be dynamically inserted here -->
        </div>
    </div>

    <!-- Universal Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div id="modalContent" class="p-6 w-full max-w-md">
            <!-- Modal content will be dynamically inserted here -->
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, runTransaction, arrayUnion, deleteDoc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Initialization and Auth ---

        // These global variables are provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'weirdforums-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // This is a fallback config for local development.
            apiKey: "AIzaSyDbel92OjeP72VFFOtmatixYSlV6VFZA5U",
            authDomain: "weirdforums-5b446.firebaseapp.com",
            projectId: "weirdforums-5b446",
            storageBucket: "weirdforums-5b446.appspot.com",
            messagingSenderId: "866428774967",
            appId: "1:866428774967:web:1f7cab540310cf8408edb2"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, storage, threadsCol, bugReportsCol;
        let currentFirebaseUid = null; // Firebase's internal UID for the user
        let currentUserId = null;      // Our custom, persistent, and unique ID for the user
        let currentUserDisplayName = "Anonymous"; // User's chosen display name

        // Get UI elements
        const userInfoDisplay = document.getElementById('userInfo');

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            
            // Define collections
            threadsCol = collection(db, `artifacts/${appId}/public/data/threads`);
            bugReportsCol = collection(db, `artifacts/${appId}/public/data/bug_reports`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in.
                    currentFirebaseUid = user.uid;
                    await loadOrCreateUserSession(currentFirebaseUid); // Load or create custom user data
                    
                    // Update UI with the user's session info
                    userInfoDisplay.innerHTML = `User: ${currentUserDisplayName} (ID: ${currentUserId.substring(0, 6)})`;

                    // Start listening for thread updates now that we have a user identity
                    listenForThreads();
                } else {
                    // User is signed out, attempt to sign in.
                    userInfoDisplay.innerText = 'Authenticating...';
                    try {
                        // Use the provided token if available, otherwise sign in anonymously.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        userInfoDisplay.innerText = 'Auth Failed. Refresh.';
                        showErrorModal("Authentication failed. Please check the console for details.");
                    }
                }
            });
        }

        // --- User Session Management (Anonymous ID & Username) ---

        async function loadOrCreateUserSession(firebaseUid) {
            const userProfileRef = doc(db, `artifacts/${appId}/users/${firebaseUid}/profile`, 'userProfile');
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    // User profile exists, load data
                    const profileData = docSnap.data();
                    currentUserId = profileData.customId;
                    currentUserDisplayName = profileData.displayName;
                } else {
                    // User profile does not exist, create a new one
                    const newCustomId = crypto.randomUUID();
                    const guestNumber = Math.floor(Math.random() * 9999) + 1;
                    const newDisplayName = `Guest-${guestNumber}`;

                    await setDoc(userProfileRef, {
                        customId: newCustomId,
                        displayName: newDisplayName,
                        createdAt: serverTimestamp()
                    });
                    currentUserId = newCustomId;
                    currentUserDisplayName = newDisplayName;
                }
            } catch (error) {
                console.error("Error loading/creating user session:", error);
                showErrorModal("Failed to load user session. Some features may not work.");
                // Fallback to a random ID if Firestore fails, to allow temporary usage
                currentUserId = crypto.randomUUID();
                currentUserDisplayName = `Guest-${Math.floor(Math.random() * 9999) + 1}`;
            }
        }

        // --- Thread Creation ---

        window.createThread = async () => {
            if (!currentUserId) {
                showErrorModal("User session not established. Please refresh the page.");
                return;
            }
            
            // Get data from form
            const title = document.getElementById("threadTitle").value.trim();
            const content = document.getElementById("threadContent").value.trim();
            const fileInput = document.getElementById("imageFile");
            const file = fileInput.files[0];
            
            // Use the stored display name
            const name = currentUserDisplayName;
            
            if (!title || !content) {
                showErrorModal("Thread title and content cannot be empty.");
                return;
            }

            const submitButton = document.getElementById("threadSubmitButton");
            const spinner = document.getElementById("threadSubmitSpinner");
            const buttonText = document.getElementById("threadSubmitText");

            // Disable button and show status
            submitButton.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.innerText = 'Posting...';

            try {
                let imageUrl = "";
                if (file) {
                    // Upload image to Firebase Storage
                    const imgRef = storageRef(storage, `images/${Date.now()}_${file.name}`);
                    await uploadBytes(imgRef, file);
                    imageUrl = await getDownloadURL(imgRef);
                }

                // Add thread to Firestore
                await addDoc(threadsCol, {
                    authorId: currentUserId,
                    authorName: name,
                    title: title,
                    content: content,
                    imageUrl: imageUrl,
                    timestamp: serverTimestamp(),
                    likedBy: [],
                    dislikedBy: [],
                    replies: []
                });

                // Clear form fields
                document.getElementById("threadTitle").value = "";
                document.getElementById("threadContent").value = "";
                fileInput.value = "";

            } catch (error) {
                console.error("Error creating thread:", error);
                showErrorModal("Failed to create thread. Please check the console for details and ensure your Firebase security rules allow writes.");
            } finally {
                // Re-enable button and hide status
                submitButton.disabled = false;
                spinner.classList.add('hidden');
                buttonText.innerText = 'Start Thread';
            }
        };

        // --- Thread Rendering ---

        function listenForThreads() {
            if (!threadsCol) {
                console.error("Firestore threads collection not initialized.");
                return;
            }
            // We sort the threads on the client-side after fetching.
            const q = query(threadsCol);
            
            onSnapshot(q, (snapshot) => {
                const threads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort threads by timestamp client-side. Newest first.
                threads.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderThreads(threads);
            }, (error) => {
                console.error("Error listening to threads:", error);
                document.getElementById("threadsContainer").innerHTML = `<div class="text-center text-red-400 py-8">Error loading threads. Please check the console.</div>`;
            });
        }

        function renderThreads(threads) {
            const container = document.getElementById("threadsContainer");
            container.innerHTML = ""; // Clear existing threads

            if (threads.length === 0) {
                container.innerHTML = `<div class="text-center text-main/80 py-8 text-2xl">No threads yet. Be the first!</div>`;
                return;
            }

            threads.forEach(thread => {
                if (!thread.content) return; // Skip threads with no content

                const threadDiv = document.createElement("div");
                threadDiv.className = "py-4 border-b border-main/30";
                threadDiv.id = `thread-${thread.id}`;

                const threadDate = thread.timestamp ? new Date(thread.timestamp.toMillis()).toLocaleString() : 'Just now';
                const replyCount = (thread.replies || []).length;
                const likeCount = (thread.likedBy || []).length;
                const dislikeCount = (thread.dislikedBy || []).length;
                const isAuthor = thread.authorId === currentUserId;
                
                // Sort replies by timestamp before rendering
                const sortedReplies = (thread.replies || []).sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                const hasLiked = (thread.likedBy || []).includes(currentUserId);
                const hasDisliked = (thread.dislikedBy || []).includes(currentUserId);
                const likeBtnClass = hasLiked ? 'btn-like active' : 'btn-like';
                const dislikeBtnClass = hasDisliked ? 'btn-dislike active' : 'btn-dislike';

                threadDiv.innerHTML = `
                    <!-- Thread Header (Clickable to Toggle) -->
                    <div class="flex justify-between items-start cursor-pointer group" onclick="toggleThreadContent('thread-content-${thread.id}')">
                        <div>
                            <h3 class="text-2xl group-hover:text-white">${thread.title}</h3>
                            <p class="text-lg text-main/70">by ${thread.authorName} - ${threadDate}</p>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <p class="text-xl">Msg: ${replyCount}</p>
                            <div class="flex gap-3 justify-end mt-1 text-lg">
                                <span class="text-green-400">👍 ${likeCount}</span>
                                <span class="text-red-400">👎 ${dislikeCount}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Thread Content (Hidden by default) -->
                    <div id="thread-content-${thread.id}" class="hidden mt-4 pl-5 border-l-2 border-main/50">
                        <p class="text-lg whitespace-pre-wrap my-4">${thread.content}</p>
                        ${thread.imageUrl ? `<img src="${thread.imageUrl}" alt="User uploaded image" class="max-w-full max-h-96 my-4" onerror="this.style.display='none'"/>` : ""}
                        
                        <!-- Action Buttons -->
                        <div class="flex items-center gap-3 flex-wrap pt-3 mt-3">
                            <button onclick="toggleReaction(event, '${thread.id}', 'like')" class="px-3 py-1 ${likeBtnClass}">👍</button>
                            <button onclick="toggleReaction(event, '${thread.id}', 'dislike')" class="px-3 py-1 ${dislikeBtnClass}">👎</button>
                            <button onclick="showReplyModal(event, '${thread.id}')" class="px-3 py-1">Reply</button>
                            ${isAuthor ? `
                            <button onclick="showEditModal(event, '${thread.id}', \`${encodeURIComponent(thread.content)}\`, \`${encodeURIComponent(thread.title)}\`)" class="px-3 py-1">✏️ Edit</button>
                            <button onclick="showDeleteModal(event, '${thread.id}')" class="px-3 py-1">🗑️ Delete</button>
                            ` : ''}
                        </div>

                        <!-- Replies -->
                        <div id="replies-${thread.id}" class="mt-4 space-y-3">
                            ${sortedReplies.map(r => `
                                <div class="bg-black/20 p-3">
                                    <p class="text-lg whitespace-pre-wrap">${r.content}</p>
                                    <p class="text-sm text-main/60 mt-1">by ${r.authorName || 'Anonymous'} (${r.timestamp ? new Date(r.timestamp.toMillis()).toLocaleString() : 'Just now'})</p>
                                </div>
                            `).join("")}
                        </div>
                    </div>
                `;
                container.appendChild(threadDiv);
            });
        }
        
        // --- Toggle Thread Visibility ---
        window.toggleThreadContent = (id) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('hidden');
            }
        }

        // --- Thread Actions (Like, Dislike) ---
        
        window.toggleReaction = async (event, threadId, reactionType) => {
            event.stopPropagation(); // Prevent thread from collapsing
            if (!currentUserId) {
                showErrorModal("You must be logged in to react. Please refresh the page.");
                return;
            }
            const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);

            try {
                await runTransaction(db, async (transaction) => {
                    const threadDoc = await transaction.get(threadRef);
                    if (!threadDoc.exists()) {
                        throw "Document does not exist!";
                    }

                    const threadData = threadDoc.data();
                    const likedBy = threadData.likedBy || [];
                    const dislikedBy = threadData.dislikedBy || [];
                    
                    const hasLiked = likedBy.includes(currentUserId);
                    const hasDisliked = dislikedBy.includes(currentUserId);

                    let newLikedBy = [...likedBy];
                    let newDislikedBy = [...dislikedBy];

                    if (reactionType === 'like') {
                        if (hasLiked) {
                            newLikedBy = newLikedBy.filter(id => id !== currentUserId); // Unlike
                        } else {
                            newLikedBy.push(currentUserId); // Like
                            if (hasDisliked) {
                                newDislikedBy = newDislikedBy.filter(id => id !== currentUserId); // Remove dislike
                            }
                        }
                    } else if (reactionType === 'dislike') {
                        if (hasDisliked) {
                            newDislikedBy = newDislikedBy.filter(id => id !== currentUserId); // Undislike
                        } else {
                            newDislikedBy.push(currentUserId); // Dislike
                            if (hasLiked) {
                                newLikedBy = newLikedBy.filter(id => id !== currentUserId); // Remove like
                            }
                        }
                    }
                    
                    transaction.update(threadRef, { likedBy: newLikedBy, dislikedBy: newDislikedBy });
                });
            } catch (error) {
                console.error("Transaction failed: ", error);
                showErrorModal("Could not update reaction. Please try again.");
            }
        };

        // --- Modal Management ---

        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');

        function showModal(content) {
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }

        window.hideModal = () => {
            modal.classList.add('hidden');
            modalContent.innerHTML = '';
        }
        
        // Hide modal when clicking outside of the content area
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideModal();
            }
        });

        // --- Error Modal ---
        window.showErrorModal = (message) => {
            const content = `
                <h3 class="text-2xl font-bold text-red-500 mb-4">Error</h3>
                <p class="text-lg">${message}</p>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="hideModal()">Close</button>
                </div>
            `;
            showModal(content);
        }

        // --- Update Log Modal ---
        window.showUpdateLog = () => {
            const content = `
                <h3 class="text-2xl font-bold mb-4">Update Log</h3>
                <div class="space-y-4 text-lg">
                    <div>
                        <p class="font-bold text-white">Oct 28, 2025 - Winnipeg, MB</p>
                        <ul class="list-disc list-inside mt-1">
                            <li>New design.</li>
                            <li>Added "Report a bug" button.</li>
                            <li>Firebase Working, you can post threads</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-bold text-white">Aug 23, 2025 - Winnipeg, MB</p>
                        <ul class="list-disc list-inside text-sm mt-1">
                            <li>Went offline.</li>
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="hideModal()">Close</button>
                </div>
            `;
            showModal(content);
        }
        
        // --- Report Bug Modal ---
        window.showReportBugModal = () => {
            const content = `
                <h3 class="text-2xl font-bold mb-4">Report a Bug</h3>
                <p class="text-lg mb-2">Found an issue? Let us know!</p>
                <p class="text-sm text-main/70 mb-4">Your User ID: ${currentUserId}</p>
                <textarea id="modal-bug-textarea" class="w-full text-lg" rows="5" placeholder="Describe the bug..."></textarea>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="hideModal()">Cancel</button>
                    <button id="confirmBugReportBtn" onclick="confirmBugReport()">Send Report</button>
                </div>
            `;
            showModal(content);
        }
        
        window.confirmBugReport = async () => {
            const bugContent = document.getElementById('modal-bug-textarea').value.trim();
            if (!bugContent) return;
            
            const reportButton = document.getElementById('confirmBugReportBtn');
            reportButton.disabled = true;
            reportButton.innerText = "Sending...";

            try {
                await addDoc(bugReportsCol, {
                    userId: currentUserId,
                    userName: currentUserDisplayName,
                    report: bugContent,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
                hideModal();
                // Show a simple confirmation
                showModal(`
                    <h3 class="text-2xl font-bold mb-4">Report Sent</h3>
                    <p class="text-lg">Thanks for your help!</p>
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="hideModal()">Close</button>
                    </div>
                `);
            } catch (error) {
                console.error("Error sending bug report:", error);
                showErrorModal("Could not send report. Please try again.");
                reportButton.disabled = false;
                reportButton.innerText = "Send Report";
            }
        }

        // --- Modal Actions (Reply, Edit, Delete) ---

        window.showReplyModal = (event, threadId) => {
            event.stopPropagation();
            if (!currentUserId) {
                showErrorModal("User session not established. Please refresh the page.");
                return;
            }
            const content = `
                <h3 class="text-2xl font-bold mb-4">Post a Reply</h3>
                <textarea id="modal-textarea" class="w-full text-lg" rows="4" placeholder="Your reply..."></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="hideModal()">Cancel</button>
                    <button onclick="confirmReply('${threadId}')">Send</button>
                </div>
            `;
            showModal(content);
        }

        window.confirmReply = async (threadId) => {
            const replyContent = document.getElementById('modal-textarea').value.trim();
            if (!replyContent) return; 
            
            if (!currentUserId) {
                showErrorModal("User session not established. Please refresh the page.");
                hideModal();
                return;
            }

            const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);
            const newReply = {
                authorId: currentUserId,
                authorName: currentUserDisplayName,
                content: replyContent,
                timestamp: serverTimestamp() 
            };
            try {
                await updateDoc(threadRef, {
                    replies: arrayUnion(newReply)
                });
                hideModal();
            } catch (error) {
                console.error("Error adding reply:", error);
                showErrorModal("Failed to add reply. Please try again.");
            }
        }

        window.showEditModal = (event, threadId, content, title) => {
            event.stopPropagation();
            const decodedContent = decodeURIComponent(content);
            const decodedTitle = decodeURIComponent(title);
            const modalHTML = `
                <h3 class="text-2xl font-bold mb-4">Edit Your Thread</h3>
                <input id="modal-title-input" class="w-full text-lg mb-4" value="${decodedTitle}">
                <textarea id="modal-textarea" class="w-full text-lg" rows="6">${decodedContent}</textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="hideModal()">Cancel</button>
                    <button onclick="confirmEdit('${threadId}')">Save Changes</button>
                </div>
            `;
            showModal(modalHTML);
        }

        window.confirmEdit = async (threadId) => {
            const newTitle = document.getElementById('modal-title-input').value.trim();
            const newContent = document.getElementById('modal-textarea').value.trim();
            if (!newContent || !newTitle) {
                showErrorModal("Title and content cannot be empty.");
                return;
            }
            const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);
            try {
                await updateDoc(threadRef, { content: newContent, title: newTitle });
                hideModal();
            } catch (error) {
                console.error("Error updating thread:", error);
                showErrorModal("Failed to update thread. Please try again.");
            }
        }

        window.showDeleteModal = (event, threadId) => {
            event.stopPropagation();
            const content = `
                <h3 class="text-2xl font-bold mb-4">Delete Thread</h3>
                <p class="text-lg">Are you sure you want to permanently delete this thread and all its replies?</p>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="hideModal()">Cancel</button>
                    <button onclick="confirmDelete('${threadId}')" style="background-color: #ef4444; color: white;">Delete</button>
                </div>
            `;
            showModal(content);
        }

        window.confirmDelete = async (threadId) => {
            const threadRef = doc(db, `artifacts/${appId}/public/data/threads`, threadId);
            try {
                await deleteDoc(threadRef);
                hideModal();
            } catch (error) {
                console.error("Error deleting thread:", error);
                showErrorModal("Failed to delete thread. Please try again.");
            }
        }

        // --- Start the app ---
        initializeFirebase();

    </script>
</body>
</html>
